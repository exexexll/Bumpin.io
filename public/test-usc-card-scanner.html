<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USC Card Barcode Scanner - Test</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #990000 0%, #FFCC00 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            text-align: center;
            font-size: 1.2rem;
            margin-bottom: 2rem;
            opacity: 0.9;
        }

        .scanner-section {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        #reader {
            border-radius: 10px;
            overflow: hidden;
            max-width: 100%;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            min-width: 120px;
            padding: 15px 25px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-start {
            background: #990000;
            color: white;
        }

        .btn-start:hover {
            background: #770000;
            transform: scale(1.05);
        }

        .btn-stop {
            background: #ff4444;
            color: white;
        }

        .btn-stop:hover {
            background: #cc0000;
        }

        .btn-stop:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .results-section {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            padding: 25px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
        }

        .result-card {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .result-card.success {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.2);
        }

        .result-card.error {
            border-color: #f44336;
            background: rgba(244, 67, 54, 0.2);
        }

        .label {
            font-weight: bold;
            color: #FFCC00;
            margin-top: 10px;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .value {
            font-family: 'Courier New', monospace;
            font-size: 1.3rem;
            margin-top: 5px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            word-break: break-all;
        }

        .value.large {
            font-size: 2rem;
            color: #4CAF50;
            font-weight: bold;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #FFCC00;
        }

        .stat-label {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-top: 5px;
        }

        .scan-log {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 15px;
        }

        .log-entry {
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid #FFCC00;
            border-radius: 5px;
            font-size: 0.9rem;
            font-family: 'Courier New', monospace;
        }

        .validation-section {
            background: rgba(255, 204, 0, 0.1);
            border: 2px solid #FFCC00;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .validation-check {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin: 8px 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        .check-icon {
            font-size: 1.5rem;
        }

        .benchmark {
            background: linear-gradient(135deg, #4CAF50 0%, #2196F3 100%);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .benchmark-value {
            font-family: 'Courier New', monospace;
            font-size: 2.5rem;
            font-weight: bold;
            margin: 15px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéì USC Card Barcode Scanner</h1>
        <p class="subtitle">Test Scanner - Verify Your Campus Card</p>

        <!-- Scanner Section -->
        <div class="scanner-section">
            <div id="reader" style="width: 100%;"></div>
            
            <div class="controls">
                <button id="startBtn" class="btn-start" onclick="startScanning()">
                    üì∑ Start Scanning
                </button>
                <button id="stopBtn" class="btn-stop" onclick="stopScanning()" disabled>
                    ‚èπ Stop Scanner
                </button>
            </div>

            <div style="margin-top: 15px; padding: 15px; background: #f0f0f0; border-radius: 10px; color: #333;">
                <strong style="color: #990000;">üìã Instructions:</strong>
                <ol style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
                    <li>Click "Start Scanning" to activate camera</li>
                    <li>Flip your USC card to the BACK side</li>
                    <li>Align the barcode (horizontal black bars) in the viewfinder</li>
                    <li>Hold steady - scanner reads automatically</li>
                </ol>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section">
            <h2 style="margin-bottom: 20px; font-size: 1.8rem;">üìä Scan Results</h2>

            <!-- Current Scan Result -->
            <div id="currentResult" class="result-card">
                <p style="opacity: 0.7;">No scan yet. Start scanning to see results.</p>
            </div>

            <!-- Statistics -->
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-number" id="totalScans">0</div>
                    <div class="stat-label">Total Scans</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="validScans">0</div>
                    <div class="stat-label">Valid USC IDs</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="invalidScans">0</div>
                    <div class="stat-label">Invalid Scans</div>
                </div>
            </div>

            <!-- Validation Checks -->
            <div id="validationSection" style="display: none;">
                <div class="validation-section">
                    <h3 style="margin-bottom: 15px; font-size: 1.3rem;">‚úÖ Validation Checks</h3>
                    <div id="validationChecks"></div>
                </div>
            </div>

            <!-- Benchmark USC ID (After First Valid Scan) -->
            <div id="benchmarkSection" style="display: none;">
                <div class="benchmark">
                    <h3 style="font-size: 1.5rem; margin-bottom: 10px;">üéØ BENCHMARK USC ID</h3>
                    <p style="opacity: 0.9; margin-bottom: 10px;">This is the reference for valid USC cards</p>
                    <div class="benchmark-value" id="benchmarkValue">-</div>
                    <p style="font-size: 0.9rem; opacity: 0.8; margin-top: 10px;">
                        All future scans will be validated against this format
                    </p>
                </div>
            </div>

            <!-- Scan Log -->
            <div class="scan-log">
                <h3 style="margin-bottom: 15px; font-size: 1.2rem;">üìú Scan History (Last 10)</h3>
                <div id="scanLog"></div>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        const USC_ID_CONFIG = {
            LENGTH: 10,
            PATTERN: /^[0-9]{10}$/,
            // Will be set after first successful scan
            BENCHMARK: null,
        };

        // ===== STATE =====
        let scanner = null;
        let isScanning = false;
        let scanCount = 0;
        let validCount = 0;
        let invalidCount = 0;
        let scanHistory = [];
        let consecutiveReads = []; // For multi-read validation

        // ===== BARCODE EXTRACTION =====
        function extractUSCId(rawValue) {
            console.log('[Extract] Raw value:', rawValue);
            
            // Remove all non-digits
            const digitsOnly = rawValue.replace(/\D/g, '');
            console.log('[Extract] Digits only:', digitsOnly);
            
            // If exactly 10 digits, that's the USC ID
            if (digitsOnly.length === 10) {
                return digitsOnly;
            }
            
            // If longer, try to find 10-digit sequence
            const match = digitsOnly.match(/(\d{10})/);
            if (match) {
                console.log('[Extract] Found 10-digit sequence:', match[1]);
                return match[1];
            }
            
            // If shorter or no match
            console.log('[Extract] Could not extract USC ID');
            return null;
        }

        // ===== VALIDATION =====
        function validateUSCId(uscId) {
            const checks = [];
            let isValid = true;

            // Check 1: Length
            const lengthValid = uscId.length === USC_ID_CONFIG.LENGTH;
            checks.push({
                name: 'Length Check',
                pass: lengthValid,
                detail: `${uscId.length} digits (expected: ${USC_ID_CONFIG.LENGTH})`,
            });
            if (!lengthValid) isValid = false;

            // Check 2: Format (all digits)
            const formatValid = USC_ID_CONFIG.PATTERN.test(uscId);
            checks.push({
                name: 'Format Check',
                pass: formatValid,
                detail: formatValid ? 'All numeric ‚úì' : 'Contains non-numeric characters',
            });
            if (!formatValid) isValid = false;

            // Check 3: Range (reasonable student ID range)
            const idNumber = parseInt(uscId);
            const rangeValid = idNumber >= 1000000000 && idNumber <= 9999999999;
            checks.push({
                name: 'Range Check',
                pass: rangeValid,
                detail: `ID: ${idNumber.toLocaleString()}`,
            });
            if (!rangeValid) isValid = false;

            // Check 4: Benchmark comparison (if set)
            if (USC_ID_CONFIG.BENCHMARK) {
                const matchesBenchmark = uscId === USC_ID_CONFIG.BENCHMARK;
                checks.push({
                    name: 'Benchmark Match',
                    pass: matchesBenchmark,
                    detail: matchesBenchmark 
                        ? 'Matches reference USC ID ‚úì' 
                        : `Different ID (benchmark: ${USC_ID_CONFIG.BENCHMARK})`,
                });
                // Don't fail on benchmark mismatch (testing different cards is valid)
            }

            return { isValid, checks, uscId };
        }

        // ===== SCAN HANDLER =====
        function onScanSuccess(decodedText, decodedResult) {
            console.log('='.repeat(60));
            console.log('[SCAN SUCCESS]');
            console.log('Raw decoded text:', decodedText);
            console.log('Format:', decodedResult.result.format);
            console.log('Full result:', decodedResult);

            // Multi-read validation (require 3 consecutive identical reads)
            consecutiveReads.push(decodedText);
            if (consecutiveReads.length > 3) {
                consecutiveReads.shift(); // Keep only last 3
            }

            // Check if all 3 reads are identical
            if (consecutiveReads.length === 3) {
                const allSame = consecutiveReads.every(r => r === consecutiveReads[0]);
                
                if (allSame) {
                    console.log('‚úÖ CONFIRMED: 3 consecutive identical reads');
                    processConfirmedScan(decodedText, decodedResult);
                    consecutiveReads = []; // Reset
                } else {
                    console.log('‚è≥ Waiting for consecutive reads...', consecutiveReads);
                }
            }
        }

        function processConfirmedScan(decodedText, decodedResult) {
            scanCount++;

            // Extract USC ID
            const uscId = extractUSCId(decodedText);

            if (!uscId) {
                invalidCount++;
                updateStats();
                displayResult({
                    success: false,
                    rawValue: decodedText,
                    format: decodedResult.result.format,
                    error: 'Could not extract 10-digit USC ID',
                });
                addToLog(decodedText, null, false, 'No USC ID found');
                return;
            }

            // Validate
            const validation = validateUSCId(uscId);

            if (validation.isValid) {
                validCount++;
                
                // Set as benchmark if first valid scan
                if (!USC_ID_CONFIG.BENCHMARK) {
                    USC_ID_CONFIG.BENCHMARK = uscId;
                    document.getElementById('benchmarkSection').style.display = 'block';
                    document.getElementById('benchmarkValue').textContent = uscId;
                    
                    // Confetti or celebration effect
                    console.log('üéâ BENCHMARK SET:', uscId);
                    alert(`üéØ Benchmark USC ID Set!\n\n${uscId}\n\nAll future scans will be compared to this.`);
                }
                
                displayResult({
                    success: true,
                    rawValue: decodedText,
                    uscId: uscId,
                    format: decodedResult.result.format,
                    validation: validation.checks,
                });
                
                addToLog(decodedText, uscId, true, 'Valid USC ID');
            } else {
                invalidCount++;
                displayResult({
                    success: false,
                    rawValue: decodedText,
                    uscId: uscId,
                    format: decodedResult.result.format,
                    validation: validation.checks,
                    error: 'Failed validation checks',
                });
                
                addToLog(decodedText, uscId, false, 'Validation failed');
            }

            updateStats();
        }

        function onScanError(errorMessage) {
            // Ignore - this fires constantly when no barcode in view
            // Only log actual errors
            if (errorMessage && !errorMessage.includes('NotFoundException')) {
                console.warn('[Scanner] Error:', errorMessage);
            }
        }

        // ===== DISPLAY FUNCTIONS =====
        function displayResult(result) {
            const container = document.getElementById('currentResult');
            const className = result.success ? 'result-card success' : 'result-card error';
            
            let html = `<div class="${className}">`;
            
            if (result.success) {
                html += `
                    <h3 style="font-size: 1.5rem; margin-bottom: 15px; color: #4CAF50;">
                        ‚úÖ VALID USC CARD DETECTED
                    </h3>
                    
                    <div class="label">USC ID Number</div>
                    <div class="value large">${result.uscId}</div>
                    
                    <div class="label">Raw Barcode Value</div>
                    <div class="value">${result.rawValue}</div>
                    
                    <div class="label">Barcode Format</div>
                    <div class="value">${result.format || 'Unknown'}</div>
                `;
            } else {
                html += `
                    <h3 style="font-size: 1.5rem; margin-bottom: 15px; color: #f44336;">
                        ‚ùå INVALID SCAN
                    </h3>
                    
                    <div class="label">Raw Barcode Value</div>
                    <div class="value">${result.rawValue}</div>
                    
                    <div class="label">Barcode Format</div>
                    <div class="value">${result.format || 'Unknown'}</div>
                    
                    <div class="label">Error</div>
                    <div class="value" style="color: #f44336;">${result.error}</div>
                `;
                
                if (result.uscId) {
                    html += `
                        <div class="label">Extracted USC ID (Invalid)</div>
                        <div class="value">${result.uscId}</div>
                    `;
                }
            }

            html += `</div>`;
            container.innerHTML = html;

            // Show validation checks
            if (result.validation) {
                showValidation(result.validation);
            }
        }

        function showValidation(checks) {
            const section = document.getElementById('validationSection');
            const container = document.getElementById('validationChecks');
            
            let html = '';
            checks.forEach(check => {
                const icon = check.pass ? '‚úÖ' : '‚ùå';
                html += `
                    <div class="validation-check">
                        <span class="check-icon">${icon}</span>
                        <div style="flex: 1;">
                            <strong>${check.name}</strong>
                            <div style="font-size: 0.9rem; opacity: 0.8; margin-top: 3px;">
                                ${check.detail}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            section.style.display = 'block';
        }

        function updateStats() {
            document.getElementById('totalScans').textContent = scanCount;
            document.getElementById('validScans').textContent = validCount;
            document.getElementById('invalidScans').textContent = invalidCount;
        }

        function addToLog(rawValue, uscId, success, message) {
            const timestamp = new Date().toLocaleTimeString();
            const entry = {
                time: timestamp,
                raw: rawValue,
                uscId: uscId,
                success: success,
                message: message,
            };
            
            scanHistory.unshift(entry); // Add to front
            if (scanHistory.length > 10) {
                scanHistory.pop(); // Keep only last 10
            }
            
            updateScanLog();
        }

        function updateScanLog() {
            const container = document.getElementById('scanLog');
            
            if (scanHistory.length === 0) {
                container.innerHTML = '<p style="opacity: 0.5; text-align: center;">No scans yet</p>';
                return;
            }
            
            let html = '';
            scanHistory.forEach((entry, index) => {
                const icon = entry.success ? '‚úÖ' : '‚ùå';
                html += `
                    <div class="log-entry">
                        <strong>${icon} [${entry.time}]</strong>
                        ${entry.uscId ? `USC ID: ${entry.uscId}` : `Raw: ${entry.raw.substring(0, 30)}...`}
                        <span style="opacity: 0.7; margin-left: 10px;">${entry.message}</span>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ===== SCANNER CONTROL =====
        async function startScanning() {
            if (isScanning) return;

            const config = {
                fps: 5, // Scans per second (balance speed vs CPU)
                qrbox: { 
                    width: 400,  // Scanning box width
                    height: 150  // Height for horizontal barcode
                },
                aspectRatio: 16/9,
                // Supported barcode formats
                formatsToSupport: [
                    Html5QrcodeSupportedFormats.CODE_128,
                    Html5QrcodeSupportedFormats.CODE_39,
                    Html5QrcodeSupportedFormats.CODE_93,
                    Html5QrcodeSupportedFormats.ITF,
                    Html5QrcodeSupportedFormats.EAN_13,
                    Html5QrcodeSupportedFormats.EAN_8,
                ],
            };

            try {
                scanner = new Html5Qrcode("reader");
                
                await scanner.start(
                    { facingMode: "environment" }, // Back camera (better for scanning)
                    config,
                    onScanSuccess,
                    onScanError
                );

                isScanning = true;
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                
                console.log('‚úÖ Scanner started successfully');
                console.log('üì± Camera active - hold USC card barcode in view');
            } catch (err) {
                console.error('‚ùå Scanner start failed:', err);
                alert(`Camera Error: ${err.message || err}\n\nPlease allow camera permission and try again.`);
            }
        }

        async function stopScanning() {
            if (!isScanning || !scanner) return;

            try {
                await scanner.stop();
                scanner.clear();
                scanner = null;
                isScanning = false;
                consecutiveReads = [];
                
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                
                console.log('‚èπ Scanner stopped');
            } catch (err) {
                console.error('Error stopping scanner:', err);
            }
        }

        // ===== INITIALIZE =====
        console.log('üéì USC Card Scanner Test Ready');
        console.log('üìã Configuration:', USC_ID_CONFIG);
        console.log('üì∑ Click "Start Scanning" to begin');

        // Initialize log
        updateScanLog();
    </script>
</body>
</html>

